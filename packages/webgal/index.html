<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico" />
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />
    <title>DragonSpring</title>
    <style>
      .html-body__effect-background {
        height: 100vh;
        width: 100vw;
        filter: blur(50px);
        background-position: center;
        background-repeat: no-repeat;
        background-size: cover;
        position: absolute;
        top: 0;
        left: 0;
      }

      .html-body__title-enter {
        width: 2560px;
        height: 1440px;
        overflow: hidden;
        position: absolute;
        top: 0;
        z-index: 14;
        opacity: 1;
        transition: opacity 1.5s;
      }

      .title-enter__initial-background {
        height: 100%;
        width: 100%;
        position: absolute;
        background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        top: 0;
        opacity: 1;
        transition: opacity 1s;
      }

      .title-enter__white-background {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        opacity: 0;
        background: linear-gradient(
          165deg,
          rgba(255, 255, 255, 0.25) 0%,
          rgba(255, 255, 255, 1) 50%,
          rgba(255, 255, 255, 0.25) 100%
        );
        transition: opacity 1s;
      }

      .title-enter__container {
        width: 100%;
        position: absolute;
        top: 0;
        height: 100%;
        opacity: 1;
        font-size: 175%;
        transition: opacity 1s;
        z-index: 15;
        font-family: '思源宋体', Georgia, serif;
      }

      .title-enter-container__center-text {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .title-enter-container__center-text > div {
        letter-spacing: 0.25em;
        padding: 2em 2em 2em 2em;
        text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        transition: text-shadow 1s;
        font-size: 175%;
        animation: title-enter-container__center-text--blink 4s infinite;
      }

      @keyframes title-enter-container__center-text--blink {
        0% {
          text-shadow: 0 0 15px rgba(0, 0, 0, 0.65);
        }
        50% {
          text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        100% {
          text-shadow: 0 0 15px rgba(0, 0, 0, 0.65);
        }
      }

      .title-enter-container__link-to-github {
        position: absolute;
        bottom: 1em;
        color: #999;
        font-size: 75%;
        display: flex;
        justify-content: center;
        width: 100%;
        flex-flow: column;
        align-items: center;
      }

      .title-enter-container__link-to-github > div {
        padding: 0 0 0.25em 0;
      }
    </style>
  </head>
  <body>
    <!-- 背景模糊 -->
    <div id="ebg" class="html-body__effect-background"></div>
    <!-- 落地页 -->
    <div class="html-body__title-enter" id="Title_enter_page">
      <div class="title-enter__initial-background" id="Title_bg_container"></div>
      <div class="title-enter__white-background" id="Title_white_container"></div>
      <div class="title-enter__container" id="Title_enter_text">
        <div class="title-enter-container__center-text">
          <div>PRESS THE SCREEN TO START</div>
        </div>
        <div class="title-enter-container__link-to-github">
          <div>
            Powered by
            <a href="https://github.com/OpenWebGAL/WebGAL" onclick="jump(event, 'https://github.com/OpenWebGAL/WebGAL')">
              WebGAL
            </a>
            Framework
          </div>
        </div>
      </div>
    </div>
    <!-- 紧急回避页挂载点 -->
    <div id="panic-overlay"></div>
    <div id="html-body__panic-overlay"></div>
    <!-- 应用挂载点 -->
    <div id="root"></div>
    <!-- 在窗口大小改变时进行强制缩放 -->
    <script>
      (() => {
        const isIOSDevice = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
        const resize = () => {
          const targetHeight = 1440;
          const targetWidth = 2560;

          const h = window.innerHeight;
          const w = window.innerWidth;
          const zoomH = h / targetHeight;
          const zoomW = w / targetWidth;
          const zoomH2 = w / targetHeight;
          const zoomW2 = h / targetWidth;
          let mh = (targetHeight - h) / 2;
          let mw = (targetWidth - w) / 2;
          let mh2os = targetWidth / 2 - w / 2;
          let mw2os = targetHeight / 2 - h / 2;
          let transform = '';
          let bgTransform = '';

          const root = document.getElementById('root');
          const title = document.getElementById('Title_enter_page') || document.querySelector('.html-body__title-enter');
          const ebg = document.getElementById('ebg') || document.querySelector('.html-body__effect-background');
          const elements = [root, title];

          if (w > h) {
            if (ebg) {
              ebg.style.height = '100vh';
              ebg.style.width = '100vw';
              bgTransform = '';
            }
            mw = -mw;
            mh = -mh;
            if (w * (9 / 16) >= h) {
              transform = `translate(${mw}px, ${mh}px) scale(${zoomH},${zoomH})`;
            }
            if (w * (9 / 16) < h) {
              transform = `translate(${mw}px, ${mh}px) scale(${zoomW},${zoomW})`;
            }
          } else {
            if (ebg) {
              ebg.style.height = `${targetHeight}px`;
              ebg.style.width = `${targetWidth}px`;
            }
            mw2os = -mw2os;
            if (h * (9 / 16) >= w) {
              bgTransform = `rotate(90deg) translate(${mw2os}px, ${mh2os}px) scale(${zoomH2 * 1.75},${zoomH2 * 1.75})`;
              transform = `rotate(90deg) translate(${mw2os}px, ${mh2os}px) scale(${zoomH2},${zoomH2})`;
            }
            if (h * (9 / 16) < w) {
              bgTransform = `rotate(90deg) translate(${mw2os}px, ${mh2os}px) scale(${zoomW2 * 1.75},${zoomW2 * 1.75})`;
              transform = `rotate(90deg) translate(${mw2os}px, ${mh2os}px) scale(${zoomW2},${zoomW2})`;
            }
            if (isIOSDevice) {
              const zoomWi = w / targetWidth;
              transform = `translate(${-mw}px, ${-mh}px) scale(${zoomWi},${zoomWi})`;
            }
          }
          if (ebg) {
            ebg.style.transform = bgTransform;
          }
          for (const element of elements) {
            if (element) {
              element.style.transform = transform;
            }
          }
        };

        if (!isIOSDevice) {
          const meta = document.createElement('meta');
          meta.name = 'viewport';
          meta.content = 'width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no';
          document.getElementsByTagName('head')[0].appendChild(meta);
          resize();
          window.onload = resize;
          window.onresize = resize;
          document.onkeydown = function (event) {
            const e = event;
            if (e && e.key === 'F11') {
              setTimeout(() => {
                resize();
              }, 100);
            }
          };
        } else {
          const meta = document.createElement('meta');
          meta.name = 'viewport';
          meta.content = 'width=device-width, initial-scale=0.22, minimum-scale=0.01, maximum-scale=1';
          document.getElementsByTagName('head')[0].appendChild(meta);
          const style = document.createElement('style');
          style.type = 'text/css';
          style.textContent = '* { font-synthesis: none !important; }';
          document.head.appendChild(style);
        }
      })();
    </script>
    <!-- 注册 Service Worker -->
    <script>
      (() => {
        const isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
        if ('serviceWorker' in navigator && !isIOS) {
          navigator.serviceWorker
            .register('./webgal-serviceworker.js')
            .then((reg) => {
              console.log('Registration succeeded. Scope is ' + reg.scope);
            })
            .catch((error) => {
              console.log('Registration failed with ' + error);
            });
        }
      })();
    </script>
    <!-- 首屏加载 -->
    <script>
      (() => {
        const isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
        window.enterPromise = new Promise((res) => (window.enterPromiseResolve = res));
        window.renderPromise = new Promise((res) => {
          window.renderPromiseResolve = () => {
            res();
            delete window.renderPromiseResolve;
          };
        });
        Promise.all([window.enterPromise, window.renderPromise]).then(() => {
          const event = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: true,
          });
          const target = document.getElementById('enter_game_target') || document.querySelector('.title__enter-game-target');
          if (target) {
            target.dispatchEvent(event);
          }
          if (event) {
            const logo = document.getElementById('logo_target');
            if (logo) {
              logo.style.display = 'contents';
            }
          }
        });
        const enter = () => {
          const bgContainer = document.getElementById('Title_bg_container');
          if (bgContainer) {
            bgContainer.style.opacity = '0';
          }
          const enterText = document.getElementById('Title_enter_text');
          if (enterText) {
            enterText.style.opacity = '0';
          }
          const whiteContainer = document.getElementById('Title_white_container');
          setTimeout(() => {
            if (whiteContainer) {
              whiteContainer.style.opacity = '1';
            }
          }, 50);
          const title = document.getElementById('Title_enter_page') || document.querySelector('.html-body__title-enter');
          setTimeout(() => {
            if (title) title.style.opacity = '0';
          }, 500);
          if (!isIOS && title) {
            title.style.pointerEvents = 'none';
            title.style.background = 'linear-gradient( #a1c4fd 0%, #c2e9fb 100%)';
          }
          setTimeout(() => {
            if (title) {
              title.style.display = 'none';
            }
          }, 2000);
          if (window.enterPromiseResolve) {
            window.enterPromiseResolve();
            delete window.enterPromiseResolve;
          }
        };
        const titleEnter = document.getElementById('Title_enter_page') || document.querySelector('.html-body__title-enter');
        if (titleEnter) {
          titleEnter.onclick = enter;
        }
      })();
      function jump(event, url) {
        event.stopPropagation();
      }
    </script>
    <!-- 加载IIFE插件 -->
    <script>
      (() => {
        const loadScript = (url, type) => {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            if (type) script.type = type;
            script.onload = () => resolve(`Loaded: ${url}`);
            script.onerror = () => reject(new Error(`Failed to load: ${url}`));
            document.head.appendChild(script);
          });
        };
        const loadIifePlugin = async (pluginPath) => {
          try {
            const info = await loadScript(pluginPath);
            console.log(info);
            return true;
          } catch (error) {
            console.warn(error);
            return false;
          }
        };
        const live2d2Promise = loadIifePlugin('lib/live2d.min.js');
        const live2d4Promise = loadIifePlugin('lib/live2dcubismcore.min.js');
        window.live2dPromise = Promise.all([live2d2Promise, live2d4Promise]);
      })();
    </script>
    <!-- main文件 -->
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>